name: Apply Omni Manifests

on:
  push:
    branches: ["main"]
    paths:
      - "omni/**"
      - ".github/workflows/**"
  workflow_dispatch: {}

jobs:
  apply:
    runs-on: ubuntu-latest

    env:
      OMNI_ENDPOINT: ${{ secrets.OMNI_ENDPOINT }}
      OMNI_SERVICE_ACCOUNT_KEY: ${{ secrets.OMNI_SERVICE_ACCOUNT_TOKEN }}

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Install omnictl
        run: |
          curl -sL https://talos.dev/install-omnictl | sh
          echo "$HOME/.local/bin" >> $GITHUB_PATH
          omnictl --version

      - name: Configure omnictl
        shell: bash
        run: |
          set -euo pipefail

          # Fail fast if secrets aren't present
          test -n "${OMNI_ENDPOINT}" || (echo "OMNI_ENDPOINT is empty" && exit 1)
          test -n "${OMNI_SERVICE_ACCOUNT_KEY}" || (echo "OMNI_SERVICE_ACCOUNT_KEY is empty" && exit 1)

          mkdir -p "$HOME/.talos/omni"

          # Write config and embed the JSON key safely as a YAML block scalar
          {
            echo "contexts:"
            echo "  ci:"
            echo "    endpoint: ${OMNI_ENDPOINT}"
            echo "    serviceAccount:"
            echo "      key: |"
            printf '%s\n' "${OMNI_SERVICE_ACCOUNT_KEY}" | sed 's/^/        /'
            echo "currentContext: ci"
          } > "$HOME/.talos/omni/config"

      - name: Apply Omni manifests
        run: |
          omnictl apply -f omni/cluster-template.yaml
