name: Apply Omni Manifests

on:
  push:
    branches: ["main"]
    paths:
      - "omni/**"
      - ".github/workflows/**"
  workflow_dispatch: {}

jobs:
  apply:
    runs-on: ubuntu-latest

    env:
      OMNI_ENDPOINT: ${{ secrets.OMNI_ENDPOINT }}
      OMNI_SERVICE_ACCOUNT_KEY_B64: ${{ secrets.OMNI_SERVICE_ACCOUNT_KEY }}

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Install omnictl
        shell: bash
        run: |
          set -euo pipefail
          curl -sL https://talos.dev/install-omnictl | sh
          echo "$HOME/.local/bin" >> "$GITHUB_PATH"
          omnictl --version

      - name: Configure omnictl
        shell: bash
        run: |
          set -euo pipefail

          # Fail fast if secrets are missing
          test -n "${OMNI_ENDPOINT:-}" || (echo "OMNI_ENDPOINT is empty" && exit 1)
          test -n "${OMNI_SERVICE_ACCOUNT_KEY_B64:-}" || (echo "OMNI_SERVICE_ACCOUNT_KEY is empty" && exit 1)

          mkdir -p "$HOME/.talos/omni"

          # Decode base64 -> JSON
          OMNI_SERVICE_ACCOUNT_KEY="$(printf '%s' "$OMNI_SERVICE_ACCOUNT_KEY_B64" | base64 -d)"

          CONFIG="$HOME/.talos/omni/config"
          : > "$CONFIG"

          echo "contexts:" >> "$CONFIG"
          echo "  ci:" >> "$CONFIG"
          echo "    endpoint: ${OMNI_ENDPOINT}" >> "$CONFIG"
          echo "    serviceAccount:" >> "$CONFIG"
          echo "      key: |" >> "$CONFIG"

          # indent JSON correctly for YAML block scalar
          printf '%s\n' "$OMNI_SERVICE_ACCOUNT_KEY" | sed 's/^/        /' >> "$CONFIG"

          echo "currentContext: ci" >> "$CONFIG"

          # sanity check
          test -s "$CONFIG"

      - name: Apply Omni manifests
        shell: bash
        run: |
          set -euo pipefail
          omnictl --context ci apply -f omni/cluster-template.yaml
