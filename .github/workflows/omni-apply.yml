name: Apply Omni Manifests

on:
  push:
    branches: ["main"]
    paths:
      - "omni/**"
      - ".github/workflows/**"
  workflow_dispatch: {}

jobs:
  apply:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Install omnictl
        shell: bash
        run: |
          curl -sL https://talos.dev/install-omnictl | sh
          sudo install -m 0755 "$HOME/.local/bin/omnictl" /usr/local/bin/omnictl
          omnictl version

      - name: Apply Omni manifests
        shell: bash
        env:
          OMNI_ENDPOINT: ${{ secrets.OMNI_ENDPOINT }}
          OMNI_SERVICE_ACCOUNT_KEY: ${{ secrets.OMNI_SERVICE_ACCOUNT_TOKEN }}
        run: |
          omnictl apply omni/
